name: MZWEBSITE

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Durasi penggunaan'
        required: false
        default: '5h40m'
        type: choice
        options:
          - '1h'
          - '3h'
          - '5h40m'

jobs:
  SETUP:
    runs-on: windows-2019
    timeout-minutes: 340

    steps:
    - name: MULAI
      run: |
        Write-Host ""
        Write-Host "MZWEBSITE" -ForegroundColor Yellow
        Write-Host "Durasi : ${{ github.event.inputs.duration }}" -ForegroundColor Cyan
        Write-Host "Proses dimulai..."
        Start-Sleep 2
        Write-Host "Sistem siap." -ForegroundColor Green

    - name: KONFIGURASI
      run: |
        Write-Host "Menyiapkan layanan..."

        Set-ItemProperty `
          -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name fDenyTSConnections `
          -Value 0 -Force

        Set-ItemProperty `
          -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
          -Name UserAuthentication `
          -Value 0 -Force

        netsh advfirewall firewall add rule name="MZWEBSITE-IN" dir=in action=allow protocol=TCP localport=3389
        netsh advfirewall firewall add rule name="MZWEBSITE-OUT" dir=out action=allow protocol=TCP localport=3389

        Start-Service TermService
        Write-Host "Konfigurasi selesai." -ForegroundColor Green

    - name: BUAT AKUN
      run: |
        $username = "MZWEBSITE"
        $password = "akun#123"

        Write-Host "Menyiapkan akun..."

        Remove-LocalUser -Name $username -ErrorAction SilentlyContinue

        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        New-LocalUser `
          -Name $username `
          -Password $securePass `
          -AccountNeverExpires `
          -Description "MZWEBSITE Account"

        Set-LocalUser -Name $username -PasswordNeverExpires $true

        Add-LocalGroupMember Administrators $username
        Add-LocalGroupMember "Remote Desktop Users" $username

        Enable-LocalUser $username

        echo "USER_NAME=$username" >> $env:GITHUB_ENV
        echo "USER_PASS=$password" >> $env:GITHUB_ENV
        echo $password > $env:TEMP\user_pass.txt

        Write-Host "Akun siap." -ForegroundColor Green

    - name: JARINGAN
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "Menyiapkan jaringan..."

        $msi = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile $msi
        Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait

        & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
          --authkey=$env:TAILSCALE_AUTH_KEY `
          --hostname=mzwebsite-$env:GITHUB_RUN_ID `
          --accept-dns `
          --reset

        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        echo "ADDRESS=$ip" >> $env:GITHUB_ENV

        Write-Host "Jaringan aktif." -ForegroundColor Green

    - name: INFORMASI
      run: |
        $pass = Get-Content $env:TEMP\user_pass.txt
        $duration = "${{ github.event.inputs.duration }}"

        switch ($duration) {
          "1h"    { $totalMinutes = 60 }
          "3h"    { $totalMinutes = 180 }
          "5h40m" { $totalMinutes = 340 }
        }

        echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

        Write-Host ""
        Write-Host "INFORMASI AKSES"
        Write-Host "Alamat  : $env:ADDRESS"
        Write-Host "User    : MZWEBSITE"
        Write-Host "Sandi   : $pass"
        Write-Host "Durasi  : $duration"

    - name: JALANKAN SESI
      run: |
        $totalMinutes = [int]$env:TOTAL_MINUTES
        $endTime = (Get-Date).AddMinutes($totalMinutes)

        Write-Host "Sesi aktif. Pembaruan setiap 5 menit."

        while ((Get-Date) -lt $endTime) {
          $now = Get-Date
          $remain = $endTime - $now

          Write-Host ("[{0}] Sisa waktu: {1} jam {2} menit" -f `
            $now.ToString("HH:mm:ss"),
            [math]::Floor($remain.TotalHours),
            $remain.Minutes)

          Start-Sleep -Seconds 300
        }

        Write-Host "Durasi selesai." -ForegroundColor Red

    - name: BERSIHKAN
      if: always()
      run: |
        Write-Host "Membersihkan sistem..."

        Disable-LocalUser MZWEBSITE -ErrorAction SilentlyContinue
        Remove-Item "$env:TEMP\user_pass.txt" -ErrorAction SilentlyContinue

        & "$env:ProgramFiles\Tailscale\tailscale.exe" down -ErrorAction SilentlyContinue

        netsh advfirewall firewall delete rule name="MZWEBSITE-IN" dir=in
        netsh advfirewall firewall delete rule name="MZWEBSITE-OUT" dir=out

        Set-ItemProperty `
          -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name fDenyTSConnections `
          -Value 1 -Force

        Write-Host "Selesai." -ForegroundColor Green
